from selenium import webdriver
from pymongo import MongoClient
from selenium.webdriver.firefox.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from selenium.common import exceptions

MONGO_URI = 'mongodb://172.17.0.2:27017/'
MONGO_DATABASE = 'mvideo_db'

client = MongoClient(MONGO_URI)
mongo_base = client[MONGO_DATABASE]
collection = mongo_base['hits']



chrome_options = Options()
chrome_options.add_argument("--headless")

path = ('D:\chromedriver.exe')
driver = webdriver.Chrome(path)
driver.get('https://www.mvideo.ru')
title_site = 'MVideo'

assert title_site in driver.title


hits = driver.find_elements_by_class_name('facelift gallery-layout products--shelve gallery-layout_products gallery-layout_product-set grid-view')


while True:
    try:
        next_button = WebDriverWait(hits, 3).until(
            EC.presence_of_element_located(
                (By.CLASS_NAME, "next-btn sel-hits-button-next")
            )
        )

        driver.execute_script("$(arguments[0]).click();", next_button)
    except exceptions.TimeoutException:
        print('Finish')
        break

goods = hits.find_elements_by_xpath('li[@class="gallery-list-item"]')

item = {}
for good in goods:
    item['title'] = good.find_element_by_css_selector(
        'a.sel-product-tile-title') \
        .get_attribute('innerHTML')

    item['link'] = good.find_element_by_css_selector(
        'a.sel-product-tile-title') \
        .get_attribute('href')

    item['price'] = float(
        good.find_element_by_css_selector(
            'div.c-pdp-price__current').get_attribute('innerHTML').replace(
                '&nbsp;', '').replace('Â¤', ''))

    item['image'] = good.find_element_by_css_selector(
        'img[class="lazy product-tile-picture__image"]') \
        .get_attribute('src')

    collection.update_one({'link': item['link']}, {'$set': item},
                          upsert=True)
driver.quit()
